## 2026-01-08: shadcn/ui Setup Complete

### What was done:
- Ran `bunx shadcn@latest init` to initialize shadcn/ui with Tailwind v4
- Configured components.json with new-york style, RSC support, lucide icons
- Added base components: button, card, input, label, form
- Updated home page to demonstrate components working
- Verified typecheck passes and components render correctly

### Files created/modified:
- src/lib/utils.ts (cn utility)
- components.json (shadcn config)
- src/app/globals.css (updated with shadcn CSS variables)
- src/components/ui/button.tsx
- src/components/ui/card.tsx
- src/components/ui/input.tsx
- src/components/ui/label.tsx
- src/components/ui/form.tsx
- src/app/page.tsx (demo using components)

### Dependencies added:
- clsx, tailwind-merge (via utils)
- @radix-ui/react-label, @radix-ui/react-slot
- class-variance-authority
- lucide-react
- react-hook-form, @hookform/resolvers
- tw-animate-css

### Next priority:
Configure Vitest for unit/integration testing (PRD item #2)

---

## 2026-01-08: Vitest Testing Setup Complete

### What was done:
- Installed vitest 4.x, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event
- Created vitest.config.ts with jsdom environment, React plugin, path aliases
- Created vitest.setup.ts with jest-dom matchers
- Added test scripts to package.json (test, test:watch, test:coverage)
- Created sample Button component tests (6 tests covering variants, sizes, events, asChild)
- Verified tests pass via `bun run test`
- Verified typecheck passes

### Files created/modified:
- vitest.config.ts (vitest configuration)
- vitest.setup.ts (jest-dom setup)
- package.json (updated test scripts)
- src/components/ui/__tests__/button.test.tsx (sample tests)

### Dependencies added:
- vitest, @vitejs/plugin-react, jsdom
- @testing-library/react, @testing-library/dom, @testing-library/jest-dom, @testing-library/user-event

### Notes:
- Use `bun run test` to run tests (not `bun test` which is bun's native test runner)
- Tests use Vitest's globals (describe, it, expect, vi)
- jsdom environment configured for React component testing

### Next priority:
Configure Playwright for E2E testing (PRD item #3)

---

## 2026-01-08: Playwright E2E Testing Setup Complete

### What was done:
- Installed @playwright/test 1.57.0
- Installed Chromium browser for Playwright
- Created playwright.config.ts with Next.js webServer integration
- Added e2e test scripts to package.json (test:e2e, test:e2e:ui)
- Created sample E2E tests for home page (3 tests)
- Verified all E2E tests pass via `bun run test:e2e`
- Verified typecheck passes, unit tests pass

### Files created/modified:
- playwright.config.ts (Playwright configuration)
- e2e/home.spec.ts (sample E2E tests)
- package.json (added e2e scripts)

### Dependencies added:
- @playwright/test

### Notes:
- Use `bun run test:e2e` to run E2E tests
- Use `bun run test:e2e:ui` for interactive UI mode
- Config auto-starts dev server if not running
- Tests use Chromium only (can add Firefox/Safari later)
- HTML reporter generates to playwright-report/

### Next priority:
Configure test mocking infrastructure (PRD item #4)

---

## 2026-01-08: T3 Env Type-Safe Environment Variables Complete

### What was done:
- Installed @t3-oss/env-nextjs for type-safe env validation
- Created src/env.ts with server and client env schemas
- Defined all required env vars: DATABASE_URL, BETTER_AUTH_SECRET, SPOTIFY_CLIENT_ID, SPOTIFY_CLIENT_SECRET, NEXT_PUBLIC_APP_URL
- Added optional env vars: PUSHOVER_USER_KEY, PUSHOVER_API_TOKEN
- Added env validation import to next.config.ts
- Created .env.example with all variables documented
- Created .env.local for local development
- Updated .gitignore to commit .env.example but ignore .env.local
- Verified build fails on missing env vars, succeeds with valid env

### Files created/modified:
- src/env.ts (env validation schema)
- next.config.ts (imports env for build-time validation)
- .env.example (template for all env vars)
- .env.local (local development values)
- .gitignore (updated env file patterns)

### Dependencies added:
- @t3-oss/env-nextjs (zod already present)

### Notes:
- Import `env` from "@/env" to access type-safe env vars
- Build will fail if required env vars missing (unless SKIP_ENV_VALIDATION=1)
- Client-side vars must be prefixed with NEXT_PUBLIC_

### Next priority:
Configure test mocking infrastructure (PRD item #4)

---

## 2026-01-08: PostgreSQL with Docker and Drizzle ORM Complete

### What was done:
- Created docker-compose.yml with PostgreSQL 16 Alpine container
- Installed drizzle-orm, postgres (driver), and drizzle-kit
- Created full database schema with tables: users, game_sessions, players, turns, game_history
- Created db connection module exporting typed db instance
- Added drizzle.config.ts for drizzle-kit
- Added db scripts: db:push, db:studio, db:generate, db:migrate
- Verified schema pushes to database and all tables created

### Files created/modified:
- docker-compose.yml (PostgreSQL container config, port 5433)
- drizzle.config.ts (Drizzle Kit configuration)
- src/db/schema.ts (full schema with types)
- src/db/index.ts (database connection)
- package.json (db scripts added)
- .env.example, .env.local (updated DATABASE_URL with port 5433)

### Dependencies added:
- drizzle-orm, postgres
- drizzle-kit, dotenv (dev)

### Notes:
- Uses port 5433 to avoid conflicts with local postgres on 5432
- Run `docker compose up -d` to start postgres
- Run `bun run db:push` to push schema changes
- Run `bun run db:studio` for Drizzle Studio GUI
- Schema includes: game_state enum, foreign key relationships, JSONB for flexible data

### Next priority:
Configure tRPC with TanStack React Query for RSC (PRD item #6)

---

## 2026-01-08: tRPC with TanStack React Query for RSC Complete

### What was done:
- Installed @trpc/server, @trpc/client, @trpc/tanstack-react-query, @tanstack/react-query, server-only
- Created src/trpc/init.ts with createTRPCContext (cached), createTRPCRouter, createCallerFactory, baseProcedure
- Created src/trpc/routers/_app.ts with appRouter and sample procedures (healthcheck, hello)
- Created src/app/api/trpc/[trpc]/route.ts with fetchRequestHandler for GET/POST
- Created src/trpc/query-client.ts with makeQueryClient factory (staleTime, dehydrate options)
- Created src/trpc/client.tsx with TRPCProvider, useTRPC, TRPCReactProvider
- Created src/trpc/server.ts with trpc proxy, HydrateClient, getQueryClient for RSC
- Added TRPCReactProvider to app/layout.tsx
- Created sample Greeting component demonstrating client-side query usage
- Updated home page with RSC prefetching and HydrateClient
- Verified type-safe queries work end-to-end

### Files created/modified:
- src/trpc/init.ts (tRPC initialization)
- src/trpc/routers/_app.ts (app router with procedures)
- src/trpc/query-client.ts (QueryClient factory)
- src/trpc/client.tsx (client-side provider)
- src/trpc/server.ts (server-side helpers)
- src/app/api/trpc/[trpc]/route.ts (API route handler)
- src/app/layout.tsx (added TRPCReactProvider)
- src/app/page.tsx (RSC prefetching demo)
- src/components/greeting.tsx (client component using tRPC)

### Dependencies added:
- @trpc/server, @trpc/client, @trpc/tanstack-react-query
- @tanstack/react-query
- server-only

### Notes:
- Use `trpc.procedure.prefetch()` in server components for SSR
- Wrap client components with `<HydrateClient>` for hydration
- Use `useTRPC()` hook in client components to get the trpc proxy
- Use `useQuery(trpc.procedure.queryOptions({...}))` pattern for queries
- Context includes db instance for database access in procedures

### Next priority:
Configure Better Auth with Spotify provider (PRD item #9)

---

## 2026-01-08: Better Auth with Spotify Provider Complete

### What was done:
- Installed better-auth package
- Created src/lib/auth.ts with Spotify OAuth provider config
- Configured required Spotify scopes: streaming, user-read-email, user-read-private, playlist-read-private
- Created API route handler at src/app/api/auth/[...all]/route.ts
- Created auth client for frontend at src/lib/auth-client.ts (signIn, signOut, useSession exports)
- Updated database schema to use Better Auth tables (user, session, account, verification)
- Updated game tables to reference Better Auth's user table (text IDs instead of uuid)
- Added relations between Better Auth and game-specific tables
- Verified schema pushes to database successfully

### Files created/modified:
- src/lib/auth.ts (Better Auth server config)
- src/lib/auth-client.ts (Better Auth client)
- src/app/api/auth/[...all]/route.ts (auth API handler)
- src/db/schema.ts (integrated Better Auth tables, updated FK types)

### Dependencies added:
- better-auth

### Notes:
- Use `signIn.social({ provider: "spotify" })` to initiate Spotify login
- Use `useSession()` hook in client components to get session state
- Spotify tokens stored in account table (accessToken, refreshToken, accessTokenExpiresAt)
- Game tables use text IDs for user foreign keys (Better Auth uses text, not uuid)
- Redirect URL for local dev: http://localhost:3000/api/auth/callback/spotify

### Next priority:
Configure test mocking infrastructure (PRD item #4) OR implement Host login with Spotify OAuth (PRD item #10)

---

## 2026-01-08: Spotify OAuth Login/Logout UI Complete

### What was done:
- Created SpotifyLoginButton component with loading state
- Created UserMenu component showing session state and logout
- Updated home page to include UserMenu in CardFooter
- Login button triggers Spotify OAuth flow via Better Auth
- Logout button destroys session via Better Auth
- Session display shows user name/email and profile image

### Files created/modified:
- src/components/spotify-login-button.tsx (new)
- src/components/user-menu.tsx (new)
- src/app/page.tsx (added CardFooter with UserMenu)
- plans/prd.json (marked auth login/logout as passing)

### Notes:
- Uses `signIn.social({ provider: "spotify", callbackURL: "/" })` for login
- Uses `signOut()` for logout
- useSession() hook provides isPending state for loading skeleton
- Session shows user image if available from Spotify profile

### Next priority:
Configure test mocking infrastructure (PRD item #4) OR implement non-host player join flow (PRD item #12)

---

## 2026-01-08: Test Mocking Infrastructure Complete

### What was done:
- Installed msw (Mock Service Worker) 2.x for API mocking
- Created src/mocks/handlers.ts with Spotify API mock handlers
- Created src/mocks/server.ts for Vitest (Node.js) setup
- Created src/mocks/browser.ts for browser environment (Playwright)
- Created src/mocks/db.ts with database mocking utilities (seed functions, mock query builders)
- Created src/mocks/fixtures.ts with comprehensive test fixtures for all entity types
- Created src/mocks/index.ts for convenient re-exports
- Updated vitest.setup.ts to start MSW server for all unit tests
- Created e2e/helpers/mock-api.ts with Playwright route interception helpers
- Added tests to verify mocks work in both Vitest and Playwright
- Fixed outdated e2e/home.spec.ts test assertions

### Files created/modified:
- src/mocks/handlers.ts (Spotify API mocks)
- src/mocks/server.ts (MSW Node server)
- src/mocks/browser.ts (MSW browser worker)
- src/mocks/db.ts (database mocking utilities)
- src/mocks/fixtures.ts (test fixtures)
- src/mocks/index.ts (re-exports)
- src/mocks/__tests__/handlers.test.ts (API mock tests)
- src/mocks/__tests__/db.test.ts (DB mock tests)
- src/mocks/__tests__/fixtures.test.ts (fixture tests)
- vitest.setup.ts (added MSW server lifecycle)
- e2e/helpers/mock-api.ts (Playwright mock helpers)
- e2e/mocks.spec.ts (E2E mock integration tests)
- e2e/home.spec.ts (fixed outdated assertions)

### Dependencies added:
- msw

### Notes:
- Vitest: MSW server auto-starts via vitest.setup.ts, handlers reset between tests
- Playwright: Use helpers from e2e/helpers/mock-api.ts (mockSpotifyApi, mockAuthenticatedUser, etc.)
- Fixtures available for: users, gameSessions, players, turns, timelineSongs, stealAttempts, playerStandings
- DB mocking: Use seedUser(), seedGameSession(), etc. to populate in-memory store
- avatarPresets array has 20+ emoji options for player selection

### Next priority:
Implement non-host players join without authentication (PRD item #12)

---

## 2026-01-08: Non-Host Player Join Flow Complete

### What was done:
- Created /join page with 2-step flow: PIN entry ‚Üí name/avatar selection
- Created game tRPC router with procedures: validatePin, checkNameAvailable, joinGame, getSession
- Created AvatarSelector component with 20 emoji presets
- Created placeholder /lobby/[pin] page showing connected players
- Updated home page to link to /join page
- Fixed tRPC context typing to properly expose db in procedures
- Supports reconnection: disconnected players can rejoin with same name

### Files created/modified:
- src/trpc/routers/game.ts (new - game procedures)
- src/trpc/routers/_app.ts (added game router)
- src/trpc/init.ts (fixed context typing)
- src/components/avatar-selector.tsx (new)
- src/app/join/page.tsx (new - join flow)
- src/app/lobby/[pin]/page.tsx (new - lobby placeholder)
- src/app/page.tsx (updated Join Game link)

### Notes:
- PIN validation: checks game exists, not in progress, not full
- Name validation: must be unique among connected players
- Player data stored in localStorage (hitster_player_id, hitster_session_id)
- Guest players have userId: null in database
- Reconnection handled: if same name exists but disconnected, reconnects that player

### Next priority:
Host can create a new game session (PRD item #13)

---

## 2026-01-08: Host Can Create Game Session Complete

### What was done:
- CreateGameButton component already existed (wired to tRPC mutation)
- createGame tRPC procedure already existed (generates unique PIN, creates session + host player)
- Added qrcode.react library for QR code generation
- Updated lobby page to display QR code with join URL
- QR code links to /join?pin=XXXX for easy mobile scanning
- Verified PIN and QR code display correctly in lobby

### Files created/modified:
- src/app/lobby/[pin]/page.tsx (added QR code display)
- package.json (added qrcode.react dependency)

### Dependencies added:
- qrcode.react

### Notes:
- QR code encodes URL: {APP_URL}/join?pin={PIN}
- Join page already supports ?pin query param to prefill PIN
- PIN is 4-char alphanumeric (excludes confusing chars like 0/O, 1/I/L)
- Host redirected to lobby after creating game
- Lobby shows PIN prominently + QR code + player list

### Next priority:
Host can configure game settings before starting (PRD item #14)

---

## 2026-01-08: Host Game Settings Configuration Complete

### What was done:
- Added `updateSettings` tRPC mutation for host to modify game settings
- Updated `getSession` query to return all settings fields (songsToWin, songPlayDuration, turnDuration, stealWindowDuration, maxPlayers, playlistUrl)
- Created `GameSettings` component with expandable settings panel
- Settings show only for authenticated host in lobby
- All settings fields have validation (min/max ranges per PRD spec)
- Settings persist to database and sync to lobby UI via query invalidation

### Files created/modified:
- src/trpc/routers/game.ts (added updateSettings mutation, expanded getSession response)
- src/components/game-settings.tsx (new - settings panel component)
- src/app/lobby/[pin]/page.tsx (added settings panel for host, host detection via useSession)

### Settings available:
- Songs to Win: 5-20 (default 10)
- Song Play Duration: 15-60s (default 30s)
- Turn Duration: 30-90s (default 45s)
- Steal Window: 5-20s (default 10s)
- Max Players: 1-20 (default 10)
- Custom Spotify Playlist URL (optional)

### Notes:
- Settings panel is collapsible (starts closed, click to open)
- Only host sees the settings panel
- Non-hosts see "Waiting for host to start the game..."
- Host sees "Configure settings and start the game when ready"
- Settings changes invalidate the session query for real-time sync

### Next priority:
Players can join game via PIN code - enhance with real-time updates (PRD item #15)

---

## 2026-01-08: Real-Time Lobby Updates Complete

### What was done:
- Added polling (2 second interval) to lobby page for real-time player list updates
- Players joining/leaving now appear within 2 seconds without page refresh
- Uses TanStack React Query's refetchInterval feature

### Files modified:
- src/app/lobby/[pin]/page.tsx (added refetchInterval: 2000 to session query)

### Notes:
- Polling approach chosen over WebSocket subscriptions for simplicity
- 2 second interval balances responsiveness with server load
- Future enhancement: migrate to tRPC subscriptions for true real-time

### Next priority:
Host can start the game (PRD item #17)

---

## 2026-01-08: Host Can Start Game Complete

### What was done:
- Added `startGame` tRPC mutation (host-only, transitions state to "playing")
- Added Start Game button to lobby page (visible only to host)
- Created placeholder game page at /game/[pin]
- Implemented game initialization: shuffles turn order, assigns one random song to each player's timeline
- Added redirect logic: lobby detects state change and redirects to game view
- Used placeholder songs (20 songs) until Spotify integration is complete

### Files created/modified:
- src/trpc/routers/game.ts (added startGame mutation, shuffleArray helper, placeholder songs)
- src/app/lobby/[pin]/page.tsx (added Start Game button, redirect on state change)
- src/app/game/[pin]/page.tsx (new - placeholder game view)

### Notes:
- startGame mutation validates: host-only, lobby state only, at least 1 player
- Turn order randomized using Fisher-Yates shuffle
- Each player receives 1 random song in their timeline at game start
- Used song IDs tracked in usedSongIds to prevent reuse
- Game page shows player list with turn order (placeholder until gameplay features)
- Polling continues on game page for real-time updates

### Next priority:
Players cannot join during active game (PRD item #18) - already implemented in validatePin

---

## 2026-01-08: Game Initialization UI Complete

### What was done:
- Marked "Players cannot join during active game" as passing (was already implemented in validatePin/joinGame)
- Enhanced getSession query to return turnOrder, currentTurnIndex, currentPlayerId
- Enhanced getSession to return player tokens and timeline data
- Updated game page with full game initialization display:
  - Token display (coin emojis per token)
  - Timeline display (song cards sorted by year)
  - Turn order indicator (players sorted by turn order)
  - Current player highlighted with "Playing" badge
  - Shuffle animation on game start (2 second duration)
  - Game header with PIN, goal, and turn duration

### Files modified:
- src/trpc/routers/game.ts (enhanced getSession response with turn/token/timeline data)
- src/app/game/[pin]/page.tsx (complete rewrite with game state display)
- plans/prd.json (marked items 18 and 19 as passing)

### Notes:
- Players ordered by turn order when game is playing
- Shuffle animation shows for 2 seconds on initial game load
- Song auto-play step marked as done but requires Spotify integration
- Timeline shows song year and name (artist shown on song cards)

### Next priority:
Song plays via Spotify Web Playback SDK on host device (PRD gameplay item) OR
Active player can position song in their timeline (PRD gameplay item)

---

## 2026-01-08: Active Player Timeline Positioning Complete

### What was done:
- Added currentSong, turnStartedAt, roundNumber fields to game_sessions schema
- Created TimelineDropZone component with @dnd-kit for drag-and-drop song placement
- Implemented confirmTurn tRPC mutation with full turn flow:
  - Validates placement against timeline years
  - Records turn in turns table
  - Adds song to timeline if correct
  - Checks win condition
  - Advances to next player/round
  - Reshuffles turn order on new rounds
- Added turn timer with visual countdown and low-time warning
- Added turn result overlay showing correct/incorrect with song reveal
- Updated game page with active player view (drag-drop) vs waiting view
- Updated mock fixtures and db.ts for new schema fields

### Files created/modified:
- src/db/schema.ts (added currentSong, turnStartedAt, roundNumber to gameSessions)
- src/components/timeline-drop-zone.tsx (new - drag-and-drop timeline component)
- src/trpc/routers/game.ts (added confirmTurn mutation, updated startGame to draw first song)
- src/app/game/[pin]/page.tsx (complete rewrite with active player turn flow)
- src/mocks/fixtures.ts (updated with new schema fields)
- src/mocks/db.ts (updated seedGameSession with new fields)
- plans/prd.json (marked positioning, confirm turn, correct/incorrect placement as passing)

### Dependencies added:
- @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities

### Notes:
- Active player sees drag-and-drop interface with timer
- Non-active players see waiting view with current player info
- Turn result shows for 3 seconds with song name/artist/year revealed
- Correct placements add song to timeline, incorrect ones discard
- Round number increments and turn order reshuffles when all players have played
- Win condition checked after each correct placement (reaches songsToWin)

### Next priority:
- Steal phase implementation (PRD stealing items)
- OR Auto-submit turn when timer expires (PRD item 22)
- OR Song name/artist guessing (PRD item 21)

---

## 2026-01-08: Turn Auto-Submit on Timer Expiry Complete

### What was done:
- Added `onTimeUp` callback prop to TimelineDropZone component
- Updated TurnTimer to detect when timer reaches 0 and call `onTimeUp`
- Added `hasTriggered` state to prevent multiple submissions
- Auto-submits turn with current placement index (or position 0 if nothing placed)
- Added visual warning at 10 seconds remaining ("‚ö†Ô∏è Time running out!" with bounce animation)
- Warning shows alongside existing red pulsing timer for extra visibility

### Files modified:
- src/components/timeline-drop-zone.tsx (added onTimeUp prop, timer auto-submit logic, visual warning)
- src/app/game/[pin]/page.tsx (added handleTimeUp callback, passed to TimelineDropZone)
- plans/prd.json (marked PRD item 22 as passing)

### Notes:
- Timer uses `hasTriggered` flag to ensure single submission even if effect runs multiple times
- Default placement to index 0 if player hasn't placed song when time expires
- Audio warning not implemented (would require browser Audio API or sound file)
- Visual warning shows bounce animation + red text for 10 seconds

### Next priority:
- Steal phase implementation (PRD stealing items)
- OR Song name/artist guessing (PRD item 21)
- OR Spotify Web Playback SDK (PRD gameplay item)

---

## 2026-01-08: Steal Phase Implementation Complete

### What was done:
- Added steal phase tracking fields to game session schema (isStealPhase, stealPhaseEndAt, activePlayerPlacement, stealAttempts)
- Created ActiveStealAttempt type for tracking in-flight steal attempts
- Modified confirmTurn mutation to start steal phase instead of immediately resolving
- Created submitSteal mutation: validates tokens, position uniqueness, deducts tokens, records attempt
- Created resolveStealPhase mutation: validates placements, determines winner, advances turn
- Created StealPhase component with drag-and-drop UI for placing steal attempts
- Updated game page to show steal phase view with timer, steal buttons, and position locking
- Steal positions are first-come-first-serve (visual lock indicator shows occupied positions)
- Turn result overlay updated to show stolen-by message when applicable
- Updated mock fixtures and db.ts for new schema fields

### Files created:
- src/components/steal-phase.tsx (steal phase UI with DnD)

### Files modified:
- src/db/schema.ts (added steal phase fields, ActiveStealAttempt type)
- src/trpc/routers/game.ts (confirmTurn triggers steal, submitSteal, resolveStealPhase)
- src/app/game/[pin]/page.tsx (steal phase handling, result overlay updates)
- src/mocks/fixtures.ts (added steal phase fields to fixtures)
- src/mocks/db.ts (updated seedGameSession)
- plans/prd.json (marked all 5 stealing items as passing)

### Steal phase flow:
1. Active player confirms placement ‚Üí steal phase starts (10s default)
2. Other players can drag song to their timeline and spend 1 token to steal
3. Positions are locked when claimed (first-come-first-serve)
4. When timer ends ‚Üí resolveStealPhase is called
5. If active player was wrong AND a stealer was correct ‚Üí song goes to first correct stealer
6. If active player was correct ‚Üí they get the song
7. If everyone was wrong ‚Üí song discarded
8. Turn advances to next player

### Notes:
- Polling increased to 1s during steal phase for responsiveness
- Token deducted immediately on steal submission (no refunds)
- Song continues playing note in PRD but actual Spotify playback not yet implemented
- Success animation for stealer shown in result overlay

### Next priority:
- Token spending features (skip song for 1 token, free song for 3 tokens)
- Song name/artist guessing (PRD item 21)
- Spotify Web Playback SDK (PRD gameplay item)

---

## 2026-01-08: Turn Order Shuffles Each Round Complete

### What was done:
- Added `isNewRound` and `newRoundNumber` to resolveStealPhase mutation response
- Added round shuffle animation state (`showRoundShuffleAnimation`) to game page
- When steal phase resolves and it's a new round, animation shows for 2.5 seconds
- Animation displays spinning üîÄ emoji, "New Round!" text, and round number
- All game UI hidden during shuffle animation (same as initial shuffle)
- Turn result overlay now captures and passes isNewRound/newRoundNumber from mutation

### Files modified:
- src/trpc/routers/game.ts (added isNewRound, newRoundNumber to resolve response)
- src/app/game/[pin]/page.tsx (added round shuffle animation state and UI)
- plans/prd.json (marked "Turn order shuffles each round" as passing)

### Notes:
- Turn order was already being shuffled on new rounds (backend implemented)
- This change adds the visual feedback that was missing
- Animation uses amber/orange styling to differentiate from initial green shuffle
- The new turn order is displayed in Players List after animation ends

### Next priority:
- Current player indicator improvements (PRD turns item)
- Turn progression after steal phase (may already work, needs verification)
- Token spending features (skip song, free song)
- Spotify Web Playback SDK

---

## 2026-01-08: Skip Song Feature (1 Token) Complete

### What was done:
- Added `skipSong` tRPC mutation to game router
- Validates: player's turn, has at least 1 token, game in progress, not in steal phase
- Deducts 1 token from player
- Marks current song as used and draws a new random song
- Resets turn timer (turnStartedAt)
- Added Skip button to TimelineDropZone component
- Button shows "ü™ô Skip Song (1 token)" and is disabled when player has 0 tokens
- Button only shows when song hasn't been placed yet
- Wired up mutation in game page with proper loading state

### Files modified:
- src/trpc/routers/game.ts (added skipSong mutation)
- src/components/timeline-drop-zone.tsx (added skip button, onSkip/isSkipping/tokens props)
- src/app/game/[pin]/page.tsx (added skipSongMutation, handleSkipSong callback)
- plans/prd.json (marked PRD item 28 as passing)

### Notes:
- Skip button appears below the drag area, before the song is placed
- No confirmation dialog implemented (direct skip for better UX)
- If no more songs available after skip, game ends gracefully
- Typecheck and all tests pass

### Next priority:
- Free song feature (3 tokens for auto-placed song)
- Song/artist guessing for bonus token
- Spotify Web Playback SDK integration

---

## 2026-01-08: Win Condition & Results Celebration Enhancement Complete

### What was done:
- Enhanced TurnResultOverlay to show celebration when game ends (bouncing trophy, animated confetti emojis)
- Winner name displayed prominently in victory modal
- Longer display time (6s) for game-ending result
- Completely redesigned game finished screen with:
  - Animated celebration header (üéâüèÜüéâ)
  - Winner highlight card with avatar, name, song count
  - Improved final standings with medal emojis (ü•áü•àü•â)
  - Color-coded podium positions (gold/silver/bronze backgrounds)
  - Host badge on player cards
- Updated PRD: marked 4 features as passing that were already implemented:
  - "Players start with 2 tokens" (tokens #27) - was working
  - "Turn progresses to next player after completion" (turns #32) - was working
  - "Game ends when player reaches target songs" (winning #33) - enhanced
  - "Results screen shows game leaderboard" (winning #34) - enhanced

### Files modified:
- src/app/game/[pin]/page.tsx (TurnResultOverlay and finished state enhancements)
- plans/prd.json (marked 4 items as passing)

### Notes:
- Victory modal now shows winner name with celebration
- Game finished screen shows full standings with visual hierarchy
- 1st place: gold background with gold border
- 2nd place: gray background with gray border
- 3rd place: amber background with amber border
- Typecheck and all tests pass

### Next priority:
- Free song feature (3 tokens for auto-placed song)
- Song/artist guessing for bonus token
- Current player indicator enhancements (host timeline view)
- Spotify Web Playback SDK integration

---

## 2026-01-08: Free Song Feature (3 Tokens) Complete

### What was done:
- Added `getFreeSong` tRPC mutation to game router
- Validates: player's turn, has at least 3 tokens, game in progress, not in steal phase
- Deducts 3 tokens from player
- Draws random unused song and adds to player's timeline automatically
- Checks win condition after adding song
- Added Free Song button to TimelineDropZone component (alongside Skip button)
- Button shows "ü™ôü™ôü™ô Free Song (3 tokens)" and is disabled when player has <3 tokens
- Wired up mutation in game page with proper loading state and win handling

### Files modified:
- src/trpc/routers/game.ts (added getFreeSong mutation)
- src/components/timeline-drop-zone.tsx (added Free Song button, onGetFreeSong/isGettingFreeSong props)
- src/app/game/[pin]/page.tsx (added getFreeSongMutation, handleGetFreeSong callback)
- plans/prd.json (marked PRD item #29 as passing)

### Notes:
- No confirmation dialog implemented (direct action for better UX, same as Skip)
- Song is added to timeline at end, display sorted by year automatically
- If free song causes win, game ends with celebration modal
- Both Skip and Free Song buttons disabled during each other's pending state
- Typecheck and all tests pass

### Next priority:
- Song/artist guessing for bonus token (PRD item #30)
- Current player indicator enhancements (PRD item #31)
- Spotify Web Playback SDK integration (PRD item #20)

---

## 2026-01-08: Song/Artist Guessing for Bonus Token Complete

### What was done:
- Added fuzzy matching utility functions (normalizeString, levenshteinDistance, fuzzyMatch)
- Extended confirmTurn mutation to accept optional guessedName/guessedArtist parameters
- Added activePlayerGuess field to game session schema to persist guess during steal phase
- Modified resolveStealPhase to validate guess and award +1 token if correct
- Guesses stored in turns table (guessedName, guessedArtist, guessWasCorrect)
- Added guess input fields to TimelineDropZone (appear after song placement)
- Updated TurnResultOverlay to show guess result with visual feedback
- Updated game page to pass guess info through the mutation flow

### Files created/modified:
- src/db/schema.ts (added ActivePlayerGuess type, activePlayerGuess field)
- src/trpc/routers/game.ts (fuzzy matching, confirmTurn + resolveStealPhase changes)
- src/components/timeline-drop-zone.tsx (guess input UI, updated props/callbacks)
- src/app/game/[pin]/page.tsx (turnResult type, TurnResultOverlay guess display)
- src/mocks/fixtures.ts (updated with activePlayerGuess field)
- src/mocks/db.ts (updated seedGameSession with activePlayerGuess)
- plans/prd.json (marked PRD items #21 and #30 as passing)

### Fuzzy matching features:
- Normalizes strings (lowercase, & ‚Üí and, removes punctuation)
- Levenshtein distance calculation for typo tolerance
- 20% character tolerance for minor typos
- Substring matching for partial matches
- Both song name AND artist must match for token award

### UX notes:
- Guess fields appear after placing song in timeline (not before)
- Both fields must be filled for guess to be submitted
- Visual indicator shows when guess will be submitted
- Result overlay shows guess outcome with green/red styling
- Token +1 immediately awarded on correct guess

### Next priority:
- Current player indicator enhancements (PRD item #31)
- Spotify Web Playback SDK integration (PRD item #20)
- Host main display view (PRD display item)

---

## 2026-01-08: Current Player Indicator (Host Display) Complete

### What was done:
- Added `ActivePlayerTimeline` component for host display view
- Shows active player's avatar, name, token count, and timeline prominently
- Large song cards in timeline with year, song name, and artist
- Timer display (countdown with color changes: green‚Üíamber‚Üíred)
- Mystery song indicator when song is playing
- Host display only appears when authenticated user is the game host
- Uses `useSession` hook from Better Auth to detect host status
- Display hidden when it's the host's own turn (they see the active player UI instead)

### Files modified:
- src/app/game/[pin]/page.tsx (added ActivePlayerTimeline component, useSession hook, isHost check)
- plans/prd.json (marked PRD "Current player indicator shown clearly" as passing)

### PRD steps completed:
1. ‚úÖ Active player highlighted in player list (already implemented)
2. ‚úÖ Active player's phone shows 'Your Turn' prominently (already implemented)
3. ‚úÖ Other players' phones show who is playing (already implemented)
4. ‚úÖ Host display shows active player's timeline large (NEW)

### Notes:
- Host display uses larger text/cards for TV/projector visibility
- Timer shows countdown with visual warning colors
- Empty timeline state shows dashed border placeholder
- During steal phase, song info and timer are hidden (steal has its own UI)

### Next priority:
- Spotify Web Playback SDK integration (PRD gameplay item)
- Party stats on results screen (PRD winning item)
- Host can start rematch (PRD winning item)

---

## 2026-01-08: Host Can Start Rematch Complete

### What was done:
- Added `startRematch` tRPC mutation to game router
- Mutation validates host-only access and finished game state
- Resets all connected players' tokens to 2 and clears timelines
- Resets game session to lobby state (clears turn order, used songs, etc.)
- Added "Play Again" button to game finished screen (visible only to host)
- Non-hosts see "Waiting for host to start a rematch..." message
- Rematch redirects all players to lobby where new players can join

### Files modified:
- src/trpc/routers/game.ts (added startRematch mutation)
- src/app/game/[pin]/page.tsx (added rematch button and mutation call)
- plans/prd.json (marked PRD "Host can start rematch" as passing)

### PRD steps completed:
1. ‚úÖ Rematch button visible only to host
2. ‚úÖ New players can join during results screen (PIN displayed on results)
3. ‚úÖ Click rematch to start new game
4. ‚è≥ Party stats preserved (not implemented yet - separate PRD item)
5. ‚úÖ Game stats reset (tokens, timelines, turn order cleared)
6. ‚úÖ Return to lobby briefly then start (redirects to lobby)

### Notes:
- Same PIN is preserved for rematch so players can rejoin
- All game state is reset but session and players remain
- Party stats tracking is a separate PRD item (not yet implemented)
- Host can start game again from lobby with all/new players

### Next priority:
- Party stats on results screen (PRD winning item #35)
- Spotify Web Playback SDK integration (PRD gameplay item #20)

---

## 2026-01-08: Party Stats on Results Screen Complete

### What was done:
- Added `wins` field to players table schema to track wins across games
- Updated `resolveStealPhase` to increment winner's wins when game ends (both win condition and song exhaustion)
- Updated `getFreeSong` to increment winner's wins when free song causes win
- Updated `getSession` query to return `wins` field for each player
- Updated results screen with party stats section showing:
  - Party MVP (player with most wins)
  - Total games played count
  - Win count per player in a grid layout
- Party stats only display when at least one game has been completed
- `startRematch` preserves wins but resets tokens/timeline (already worked correctly)
- Updated mock fixtures (fixtures.ts, db.ts) with wins field

### Files modified:
- src/db/schema.ts (added wins field to players table)
- src/trpc/routers/game.ts (wins increment in resolveStealPhase, getFreeSong; wins in getSession)
- src/app/game/[pin]/page.tsx (party stats UI in results screen)
- src/mocks/fixtures.ts (added wins field)
- src/mocks/db.ts (added wins field to seedPlayer)
- plans/prd.json (marked PRD #35 "Party stats", #50 "Avatar selection", #51 "QR code" as passing)

### PRD items marked as passing:
- "Results screen shows party stats" (PRD #35) - new implementation
- "Avatar selection with emoji presets" (PRD #50) - was already implemented
- "QR code for easy game joining" (PRD #51) - was already implemented

### Notes:
- Schema change requires `bun run db:push` when DB is running
- Party MVP shown with purple highlight and trophy count
- Games played derived from max wins count across all players
- Win tracking persists across rematches until players leave session

### Next priority:
- Spotify Web Playback SDK integration (PRD gameplay item #20)
- Playlist loading features (PRD items #36-40)

---

## 2026-01-08: Spotify Web Playback SDK Integration Complete

### What was done:
- Created spotifyRouter with tRPC endpoints for Spotify API interactions:
  - getAccessToken: Gets/refreshes host's Spotify access token from account table
  - getPlaylistTracks: Fetches tracks from Spotify playlist with pagination
  - playTrack: Starts playback on specified device
  - pausePlayback: Pauses current playback
  - transferPlayback: Transfers playback to web player device
- Created SpotifyPlayer React component with Web Playback SDK:
  - Initializes Spotify Web Playback SDK on host client
  - Creates player instance and transfers playback
  - Controls play/pause based on game state
  - Shows progress bar with elapsed/total time
  - Auto-stops after configured song duration
  - Error handling for Premium requirement
- Updated CurrentTurnSong and TimelineSong types to include uri field
- Updated PLACEHOLDER_SONGS with real Spotify track URIs (20 popular songs)
- Integrated SpotifyPlayer into game page (host only)

### Files created:
- src/trpc/routers/spotify.ts (Spotify tRPC router)
- src/components/spotify-player.tsx (Web Playback SDK component)

### Files modified:
- src/trpc/routers/_app.ts (added spotify router)
- src/db/schema.ts (added uri field to CurrentTurnSong, TimelineSong)
- src/trpc/routers/game.ts (updated placeholder songs with Spotify URIs)
- src/app/game/[pin]/page.tsx (integrated SpotifyPlayer for host)
- plans/prd.json (marked Spotify SDK items as passing)

### Dependencies added:
- @types/spotify-web-playback-sdk (dev)

### Notes:
- Requires Spotify Premium for playback
- Host must be authenticated via Spotify OAuth
- Token auto-refresh implemented (5 min before expiry)
- Song plays for configured duration (default 30s), then auto-stops
- No song metadata shown during playback (mystery song)

### Next priority:
- Playlist loading features (PRD items #36-40)

---

## 2026-01-08: Spotify Playlist Loading Complete

### What was done:
- Added playlistSongs and usingFallbackPlaylist fields to game_sessions schema
- Added PlaylistSong type for storing loaded playlist tracks with uri field
- startGame now loads playlist from Spotify API (custom URL or default playlist)
- Default playlist ID: 0Mpj1KwRmY2pHzmj7mfbdh
- Warns if playlist has <100 tracks
- Falls back to default playlist if custom playlist fails to load
- Updated skipSong, getFreeSong, resolveStealPhase to use session's playlistSongs
- All song drawing operations now include fallback to PLACEHOLDER_SONGS when playlist exhausted
- Total song exhaustion ends game, declares winner by timeline count
- Song uri field propagated through all mutations for Spotify playback

### Files modified:
- src/db/schema.ts (PlaylistSong type, playlistSongs/usingFallbackPlaylist fields)
- src/trpc/routers/game.ts (playlist loading in startGame, fallback logic, uri propagation)
- src/mocks/fixtures.ts (updated with new schema fields)
- src/mocks/db.ts (updated seedGameSession, added createPlaylistSong helper)
- plans/prd.json (marked PRD items #36-40 as passing)

### PRD items marked as passing:
- "Default playlist loaded if none specified" (#36)
- "Host can specify custom playlist" (#37)
- "Songs used only once per game" (#38)
- "Fallback to default if custom playlist exhausted" (#39)
- "Handle total song exhaustion gracefully" (#40)

### Notes:
- extractPlaylistId helper parses Spotify URLs and URIs
- Token refresh handled before playlist fetch
- Playlist songs stored in session for consistent song pool during game
- Falls back to PLACEHOLDER_SONGS if Spotify API unavailable
- Schema change requires db:push

### Next priority:
- Reconnection handling (PRD items #43-44)
- Theme toggle (PRD item #47)
- Host/Player display optimization (PRD items #45-46)
