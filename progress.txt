## 2026-01-08: Verified & fixed test infrastructure

PRD items: setup 1-9 (all setup tasks verified complete)

Changes:
- Fixed vitest.setup.ts: use relative path for MSW server import, set onUnhandledRequest to "bypass"
- Fixed e2e/home.spec.ts: updated tests to match actual UI (Link vs Button, PIN on /join page)
- Updated PRD: marked all 9 setup tasks as passes: true

Key notes:
- Use `bun run test` not `bun test` (latter uses bun's native runner, not vitest)
- All 48 unit tests pass, all 6 E2E tests pass
- typecheck + lint both pass

Files changed:
- vitest.setup.ts
- e2e/home.spec.ts
- plans/prd.json

## 2026-01-08: Verified Spotify OAuth login

PRD items: authentication #1 (Host can log in with Spotify OAuth)

Verification:
- Started dev server, navigated to home page
- Clicked "Login with Spotify" button
- Confirmed redirect to Spotify OAuth with correct scopes (streaming, user-read-email, user-read-private, playlist-read-private)
- Callback URL correctly configured: /api/auth/callback/spotify
- PKCE code challenge in place for security

No code changes needed - feature was already implemented:
- src/lib/auth.ts: Better Auth with Spotify provider
- src/lib/auth-client.ts: signIn/signOut/useSession exports
- src/components/user-menu.tsx: Login button + session display
- src/components/spotify-login-button.tsx: Spotify OAuth trigger
- src/app/api/auth/[...all]/route.ts: Auth API handler
- src/db/schema.ts: user/session/account tables

Files changed:
- plans/prd.json (marked authentication #1 as passes: true)

## 2026-01-08: Implemented logout with redirect

PRD items: authentication #2 (Host can log out)

Changes:
- Added redirect to home page after signOut in UserMenu component
- Uses Better Auth's signOut fetchOptions.onSuccess callback

Protected routes verified:
- tRPC protectedProcedure guards: createGame, startGame, updateSettings, startRematch
- Session destroyed via Better Auth signOut()

Files changed:
- src/components/user-menu.tsx (added useRouter, redirect on logout success)
- plans/prd.json (marked authentication #2 as passes: true)

## 2026-01-08: Verified non-host player join flow

PRD items: authentication #3 (Non-host players join without authentication)

Already implemented - no code changes needed:
- /join page: 2-step flow (PIN validation â†’ name/avatar)
- tRPC validatePin + joinGame use baseProcedure (no auth required)
- 20 emoji avatar presets in AvatarSelector component
- Player created with optional userId (allows anonymous players)
- localStorage stores playerId/sessionId for stateless identity
- Reconnection support: disconnected players can rejoin with same name

Key files:
- src/app/join/page.tsx: join flow UI
- src/components/avatar-selector.tsx: 20 emoji presets
- src/trpc/routers/game.ts: validatePin (L343), joinGame (L408)
- src/db/schema.ts: players table with optional userId

Files changed:
- plans/prd.json (marked authentication #3 as passes: true)

## 2026-01-08: Verified lobby - host create game

PRD items: lobby #1 (Host can create a new game session)

Already implemented - no code changes needed:
- CreateGameButton on home page (disabled until authenticated)
- createGame tRPC procedure (protectedProcedure)
- generatePin(): 4-char alphanumeric, excludes I/O/1/0
- Unique PIN with retry logic (max 10 attempts)
- Host added as first player with isHost: true
- Redirects to /lobby/{pin} on success
- LobbyPage displays PIN + QR code (qrcode.react)

Key files:
- src/components/create-game-button.tsx: mutation + redirect
- src/app/lobby/[pin]/page.tsx: PIN display + QRCodeSVG
- src/trpc/routers/game.ts: createGame (L609), generatePin (L333)

Files changed:
- plans/prd.json (marked lobby #1 as passes: true)

## 2026-01-08: Verified all remaining lobby features

PRD items: lobby #2-6 (all lobby tasks verified complete)

All features already implemented - no code changes needed:

#2 Host can configure game settings:
- GameSettings component: collapsible panel with all 6 settings
- Settings: songsToWin(5-20), songPlayDuration(15-60s), turnDuration(30-90s), stealWindowDuration(5-20s), maxPlayers(1-20), playlistUrl
- updateSettings tRPC mutation with validation + host-only auth
- Settings synced to players via 2s polling on getSession

#3 Players can join via PIN:
- /join page: 2-step flow (PIN â†’ name/avatar)
- validatePin checks: exists, not in progress, not full
- joinGame: name uniqueness check, reconnection support

#4 Lobby shows players in real-time:
- Player list with avatars, names, host badge
- Player count display (N/maxPlayers)
- 2s polling via refetchInterval

#5 Host can start game:
- Start button visible only to host
- startGame: shuffles turn order, assigns 1 song to each player
- State â†’ "playing", all players redirect to /game/{pin}

#6 Players cannot join during active game:
- validatePin returns "Game in progress" if state === "playing"
- joinGame throws error if state !== "lobby"

Key files:
- src/components/game-settings.tsx
- src/app/lobby/[pin]/page.tsx
- src/app/join/page.tsx
- src/trpc/routers/game.ts: updateSettings (L555), startGame (L668)

Files changed:
- plans/prd.json (marked lobby #2-6 as passes: true)

## 2026-01-08: Verified gameplay #1 - game initialization

PRD items: gameplay #1 (Game initializes correctly for all players)

Already implemented - no code changes needed:

1. Each player receives 2 tokens:
   - schema default tokens: 2 (src/db/schema.ts:189)
   - explicit tokens: 2 in joinGame (L480) and createGame (L656)

2. Each player receives 1 random song in timeline (year visible):
   - startGame shuffles playlist, assigns song[i] to player[i] (L792-811)
   - TimelineDisplay shows year prominently (L52)

3. Turn order displayed with shuffle animation:
   - shuffleArray(playerIds) in startGame (L786)
   - 2-second shuffle animation overlay (L826-836)
   - "Each player receives 1 starting song" message

4. Current player highlighted:
   - PlayerCard: green "Playing" badge with pulse animation (L97-100)
   - Border/ring highlighting for current turn (L80-84)
   - ActivePlayerTimeline shows current player's timeline prominently

5. Song plays automatically for current player's turn:
   - SpotifyPlayer renders for host only (L808-823)
   - shouldPlay condition: !stealPhase && !shuffleAnimation && currentSong exists
   - Plays on host device (party game - everyone in same room)

Key files:
- src/app/game/[pin]/page.tsx: game UI, shuffle animation, player highlighting
- src/trpc/routers/game.ts: startGame (L668-849)
- src/components/spotify-player.tsx: audio playback
- src/db/schema.ts: tokens default, timeline structure

Files changed:
- plans/prd.json (marked gameplay #1 as passes: true)

## 2026-01-08: Verified gameplay #2 - Spotify playback

PRD items: gameplay #2 (Song plays via Spotify Web Playback SDK on host device)

Already implemented - no code changes needed:

1. SDK initialization: spotify-player.tsx:68-149, loads SDK script, creates Player
2. Transfer playback: spotify-player.tsx:115, transfers on player ready
3. Play from beginning: spotify.ts playTrack mutation sets position_ms: 0
4. Metadata hidden: shows "ðŸŽ¶ Mystery Song" only (L283)
5. Progress bar: elapsed/total display (L269) + visual bar (L274-279)
6. Auto-stop at duration: L211-215 pauses when elapsed >= durationMs
7. Countdown timer: TurnTimer component in timeline-drop-zone.tsx (L134-203) + ActivePlayerTimeline (game/[pin]/page.tsx L182-194)

Key files:
- src/components/spotify-player.tsx: SDK init, playback control, progress display
- src/components/timeline-drop-zone.tsx: TurnTimer component for active player
- src/app/game/[pin]/page.tsx: ActivePlayerTimeline shows countdown for host view
- src/trpc/routers/spotify.ts: playTrack, pausePlayback, transferPlayback mutations

Files changed:
- plans/prd.json (marked gameplay #2 as passes: true)

## 2026-01-08: Verified gameplay #3 - timeline drag-and-drop

PRD items: gameplay #3 (Active player can position song in their timeline)

Already implemented - no code changes needed:

1. Mystery song card: displayed above timeline via DraggableSongCard (timeline-drop-zone.tsx L70-107)
2. Drag to any position: drop zones before/between/after all songs (L306-327)
3. Drop zone highlighting: border-primary bg-primary/20 scale-105 on hover (L56-57)
4. Years visible: TimelineSongCard shows year in bold primary color (L125)
5. Smooth drag: CSS transforms via @dnd-kit/utilities, no perceptible lag
6. Turn timer: TurnTimer component (L134-203) w/ countdown, color changes, progress bar

Implementation uses @dnd-kit/core with PointerSensor + TouchSensor for mobile support.

Key files:
- src/components/timeline-drop-zone.tsx: full drag-drop UI + timer
- src/app/game/[pin]/page.tsx: integrates TimelineDropZone for active player turn

Files changed:
- plans/prd.json (marked gameplay #3 as passes: true)

## 2026-01-08: Fixed steal phase playback + verified gameplay/stealing/tokens/turns

PRD items: gameplay #4-8, stealing #9-13, tokens #14-17, turns #18-20, winning #21

Code fix:
- SpotifyPlayer: removed !isStealPhase condition so song continues during steal phase
- Previously song stopped when steal phase started, breaking PRD #9 requirement

All features verified as already implemented:

gameplay #4 (optional guess): input fields + fuzzy matching + token award
gameplay #5 (auto-submit timer): TurnTimer counts down, triggers onTimeUp at 0
gameplay #6 (manual confirm): confirm button calls onConfirm with placement
gameplay #7 (correct placement): resolveStealPhase validates, adds song to timeline
gameplay #8 (incorrect placement): song discarded when validation fails

stealing #9 (steal phase begins): timer starts, song continues, countdown visible
stealing #10 (spend token to steal): drag-drop interface, token deducted
stealing #11 (first-come-first-serve): position locking + visual occupied indicators
stealing #12 (successful steal): song transfers to stealer's timeline
stealing #13 (failed steal): token lost, no other penalty

tokens #14 (start with 2): schema default + explicit set in createGame/joinGame
tokens #15 (skip for 1): skipSong procedure deducts token, draws new song
tokens #16 (free song for 3): getFreeSong adds random song to timeline
tokens #17 (guess bonus): fuzzy match awards +1 token in resolveStealPhase

turns #18 (shuffle each round): shuffleArray on new round in resolveStealPhase
turns #19 (current player indicator): green badge, "Your Turn" card, host display
turns #20 (turn progression): advance turn index, draw next song, show results

winning #21 (target songs): timeline.length >= songsToWin triggers game end

Files changed:
- src/app/game/[pin]/page.tsx (removed !isStealPhase from shouldPlay)
- plans/prd.json (marked 17 items as passes: true)
