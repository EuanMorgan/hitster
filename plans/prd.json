[
  {
    "category": "setup",
    "description": "Initialize shadcn/ui component library",
    "steps": [
      "Run npx shadcn@latest init",
      "Configure tailwind.config with shadcn presets",
      "Set up components.json with correct paths",
      "Add base shadcn components (button, card, input, form)",
      "Import Button from @/components/ui/button, render in page, confirm it displays with shadcn styling"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Configure Vitest for unit and integration testing",
    "steps": [
      "Install vitest and @testing-library/react",
      "Create vitest.config.ts with Next.js compatibility",
      "Add test script to package.json",
      "Create sample test to verify setup",
      "Run 'bun run test', expect sample test passes with green output"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Configure Playwright for E2E testing",
    "steps": [
      "Install @playwright/test",
      "Create playwright.config.ts",
      "Add e2e test script to package.json",
      "Create sample E2E test for home page",
      "Run 'bun run test:e2e', expect home page test passes"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Configure test mocking infrastructure",
    "steps": [
      "Install msw (Mock Service Worker) for API mocking",
      "Create mocks/handlers.ts for Spotify API mocks",
      "Create mocks/server.ts for test server setup",
      "Create test utilities for database mocking with drizzle",
      "Add mock data fixtures for players, games, songs",
      "Run unit test using MSW mock for Spotify API, expect mocked response returned. Run E2E test with MSW, expect no real API calls"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Set up PostgreSQL with Docker and Drizzle ORM",
    "steps": [
      "Create docker-compose.yml with Postgres service",
      "Install drizzle-orm and drizzle-kit",
      "Create db/schema.ts with initial schema",
      "Create db/index.ts for database connection",
      "Add db:push and db:studio scripts to package.json",
      "Run 'bun run db:push', expect schema pushed without errors. Run 'bun run db:studio', expect Drizzle Studio opens at localhost:4983"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Configure tRPC with TanStack React Query for RSC",
    "steps": [
      "Install @trpc/server @trpc/client @trpc/tanstack-react-query @tanstack/react-query zod server-only",
      "Create src/trpc/init.ts - initialize tRPC with createTRPCContext (cached via React cache), createTRPCRouter, createCallerFactory, baseProcedure exports",
      "Create src/trpc/routers/_app.ts - define appRouter using createTRPCRouter, export type AppRouter",
      "Create src/app/api/trpc/[trpc]/route.ts - fetchRequestHandler with createTRPCContext and appRouter, export GET and POST handlers",
      "Create src/trpc/query-client.ts - makeQueryClient factory with staleTime config and dehydrate options for pending queries",
      "Create src/trpc/client.tsx ('use client') - createTRPCContext<AppRouter>() exports TRPCProvider and useTRPC, getQueryClient singleton for browser, TRPCReactProvider component wrapping QueryClientProvider and TRPCProvider",
      "Create src/trpc/server.tsx ('server-only') - createTRPCOptionsProxy with ctx/router/queryClient, cached getQueryClient, export trpc proxy and caller",
      "Add TRPCReactProvider to app/layout.tsx wrapping children",
      "Add @tanstack/react-query-devtools in TRPCReactProvider (dev only)",
      "Create hello procedure returning {greeting: string}, call from client component, expect greeting displayed and TypeScript autocomplete works on response"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Configure tRPC RSC prefetching patterns",
    "steps": [
      "In server components: use getQueryClient() and prefetchQuery(trpc.procedure.queryOptions({...})) for prefetching",
      "Wrap client components with HydrationBoundary passing dehydrate(queryClient) as state prop",
      "In client components: use useTRPC() hook to get trpc proxy, useQuery(trpc.procedure.queryOptions({...})) for queries",
      "For suspense: use useSuspenseQuery with same pattern, wrap in Suspense boundary",
      "For direct server data: use caller.procedure({...}) for server-only data fetching without client hydration",
      "Document prefetch vs fetchQuery tradeoffs (streaming vs blocking)",
      "Prefetch in server component, check Network tab shows no duplicate request from client, data renders immediately without loading state"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Configure type-safe environment variables with T3 Env",
    "steps": [
      "Install @t3-oss/env-nextjs and zod",
      "Create src/env.ts with client and server env schemas",
      "Define all required env vars (Spotify, DB, Auth)",
      "Add env validation to next.config.ts",
      "Update .env.example with all required variables",
      "Remove SPOTIFY_CLIENT_ID from .env, run 'bun run build', expect build fails with 'Missing environment variable: SPOTIFY_CLIENT_ID'"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Configure Better Auth with Spotify provider",
    "steps": [
      "Install better-auth",
      "Create lib/auth.ts with Spotify provider config",
      "Create app/api/auth/[...all]/route.ts handler",
      "Add required Spotify OAuth scopes",
      "Create auth client for frontend",
      "Add .env.example with required variables"
    ],
    "passes": true
  },
  {
    "category": "authentication",
    "description": "Host can log in with Spotify OAuth",
    "steps": [
      "Navigate to home page",
      "Click 'Login with Spotify' button",
      "Complete Spotify OAuth flow with required scopes (streaming, user-read-email, user-read-private, playlist-read-private)",
      "Redirect back to app with authenticated session",
      "Verify host account created/updated in database",
      "Verify Spotify access token stored securely"
    ],
    "passes": true
  },
  {
    "category": "authentication",
    "description": "Host can log out",
    "steps": [
      "Click logout button from authenticated state",
      "Session destroyed",
      "Redirect to home page",
      "Verify protected routes inaccessible"
    ],
    "passes": true
  },
  {
    "category": "authentication",
    "description": "Non-host players join without authentication",
    "steps": [
      "Navigate to join page",
      "Enter game PIN code",
      "Enter display name",
      "Select avatar from presets",
      "Join game room without Spotify login"
    ],
    "passes": true
  },
  {
    "category": "lobby",
    "description": "Host can create a new game session",
    "steps": [
      "Navigate to dashboard (authenticated)",
      "Click 'Create Game' button",
      "Game session created with unique 4-character alphanumeric PIN",
      "Host redirected to lobby as first player",
      "PIN code and QR code displayed for sharing"
    ],
    "passes": true
  },
  {
    "category": "lobby",
    "description": "Host can configure game settings before starting",
    "steps": [
      "Open settings panel in lobby",
      "Configure songs to win (default: 10, range: 5-20)",
      "Configure song play duration (default: 30s, range: 15-60s)",
      "Configure turn duration (default: 45s, range: 30-90s)",
      "Configure steal window duration (default: 10s, range: 5-20s)",
      "Configure max players (default: 10, range: 1-20)",
      "Configure custom Spotify playlist URL (optional, default provided)",
      "Settings saved and synced to all players in lobby"
    ],
    "passes": true
  },
  {
    "category": "lobby",
    "description": "Players can join game via PIN code",
    "steps": [
      "Navigate to join page",
      "Enter 4-character PIN code",
      "Validate PIN exists and game not in progress",
      "Enter display name (required, unique in session)",
      "Select avatar from emoji presets",
      "Join lobby, appear in player list for all participants",
      "Receive real-time updates via subscription"
    ],
    "passes": true
  },
  {
    "category": "lobby",
    "description": "Lobby shows all connected players in real-time",
    "steps": [
      "Display list of all players with avatars and names",
      "Show host indicator badge",
      "Real-time updates when players join/leave",
      "Show player count vs max players"
    ],
    "passes": true
  },
  {
    "category": "lobby",
    "description": "Host can start the game",
    "steps": [
      "Start button visible only to host",
      "Click start button",
      "Game state transitions to 'playing'",
      "All players redirected to game view",
      "Each player assigned one random song from playlist to timeline",
      "Turn order randomized",
      "First player's turn begins"
    ],
    "passes": true
  },
  {
    "category": "lobby",
    "description": "Players cannot join during active game",
    "steps": [
      "Attempt to join game with valid PIN while game in progress",
      "Show error message 'Game in progress'",
      "Redirect to home or show waiting screen"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Game initializes correctly for all players",
    "steps": [
      "Each player receives 2 tokens",
      "Each player receives 1 random song in timeline (with year visible)",
      "Turn order displayed with shuffle animation",
      "Current player highlighted",
      "Song plays automatically for current player's turn"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Song plays via Spotify Web Playback SDK on host device",
    "steps": [
      "Initialize Spotify Web Playback SDK on host client",
      "Transfer playback to web player",
      "Play song from beginning",
      "No song metadata displayed (title, artist hidden)",
      "Progress bar shows elapsed time out of configured duration (e.g., '15s / 30s')",
      "If duration set to 30s, song stops at exactly 30s and playback state updates",
      "Countdown timer visible during playback"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Active player can position song in their timeline",
    "steps": [
      "New song card appears at leftmost position in timeline",
      "Player can drag song to any position between existing songs",
      "Drop zones highlight with border/background color change on drag-over",
      "Timeline shows existing songs with years visible",
      "Card follows cursor/finger position during drag with no perceptible lag",
      "Turn timer countdown visible"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Active player can optionally guess song name and artist",
    "steps": [
      "Text input fields for song name and artist (optional)",
      "Fields remain editable until turn submitted",
      "Fuzzy matching for validation (handles & vs 'and', minor typos)",
      "Correct guess awards 1 bonus token"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Active player's turn auto-submits when timer expires",
    "steps": [
      "Turn timer counts down from configured duration",
      "Timer turns red/orange at 10s remaining, optional beep sound plays",
      "When timer reaches 0, current position is locked",
      "Turn automatically submitted with current state"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Active player can manually confirm turn early",
    "steps": [
      "Confirm button always visible during turn",
      "Click confirm to lock in position and optional guess",
      "Turn ends, steal phase begins"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Correct placement adds song to player's timeline",
    "steps": [
      "Validate song year against adjacent songs in timeline",
      "If year is between adjacent songs (or at correct boundary), placement correct",
      "Song revealed with title, artist, year",
      "Success animation plays",
      "Song permanently added to timeline"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Incorrect placement discards song",
    "steps": [
      "Validate song year against placement",
      "If year doesn't fit position, placement incorrect",
      "Song revealed with title, artist, year",
      "Show correct position indicator",
      "Failure animation plays",
      "Song discarded (not added to timeline)"
    ],
    "passes": true
  },
  {
    "category": "stealing",
    "description": "Steal phase begins after active player confirms",
    "steps": [
      "Steal phase timer starts (default 10s)",
      "Song continues playing from where it stopped",
      "Visual countdown indicator on all screens",
      "Active player sees their submission, can reflect on choice",
      "Other players can attempt to steal"
    ],
    "passes": true
  },
  {
    "category": "stealing",
    "description": "Players can spend token to attempt steal",
    "steps": [
      "Other players see active player's timeline",
      "Click 'Steal' button (costs 1 token)",
      "Drag song to position they think is correct",
      "Submit steal attempt",
      "Token deducted immediately"
    ],
    "passes": true
  },
  {
    "category": "stealing",
    "description": "Steal positions are first-come-first-serve",
    "steps": [
      "When player places steal at a position, that position is locked",
      "Other players cannot place steal at same position",
      "Visual indicator shows occupied positions",
      "Multiple players can steal at different positions"
    ],
    "passes": true
  },
  {
    "category": "stealing",
    "description": "Successful steal transfers song to stealer",
    "steps": [
      "If stealer's position is correct AND original player was wrong",
      "Song added to stealer's timeline instead",
      "Original player gets nothing",
      "Success animation for stealer"
    ],
    "passes": true
  },
  {
    "category": "stealing",
    "description": "Failed steal loses token only",
    "steps": [
      "If stealer's position is incorrect",
      "Token already deducted, no refund",
      "No other penalty",
      "Song discarded if original player also wrong"
    ],
    "passes": true
  },
  {
    "category": "tokens",
    "description": "Players start with 2 tokens",
    "steps": [
      "Game initialization gives each player 2 tokens",
      "Token count displayed on player's UI",
      "Token count visible to all players"
    ],
    "passes": true
  },
  {
    "category": "tokens",
    "description": "Active player can spend 1 token to skip song",
    "steps": [
      "Skip button visible during active player's turn",
      "Button disabled if player has 0 tokens",
      "Click skip, confirm dialog appears",
      "Token deducted, current song discarded",
      "New random song drawn and played",
      "Turn timer resets"
    ],
    "passes": true
  },
  {
    "category": "tokens",
    "description": "Active player can spend 3 tokens for free song",
    "steps": [
      "Free song button visible during turn",
      "Button disabled if player has fewer than 3 tokens",
      "Click button, confirm dialog appears",
      "3 tokens deducted",
      "Random song added to timeline at correct position automatically",
      "Turn continues normally with original song"
    ],
    "passes": true
  },
  {
    "category": "tokens",
    "description": "Correct song/artist guess awards 1 token",
    "steps": [
      "Player enters song name and artist during turn",
      "Fuzzy matching validates guess",
      "If both correct, award 1 token",
      "Visual feedback for successful guess"
    ],
    "passes": true
  },
  {
    "category": "turns",
    "description": "Turn order shuffles each round",
    "steps": [
      "Round = each player has had one turn",
      "At start of new round, shuffle turn order",
      "Shuffle animation shown on all screens",
      "New order displayed before first turn of round"
    ],
    "passes": true
  },
  {
    "category": "turns",
    "description": "Current player indicator shown clearly",
    "steps": [
      "Active player highlighted in player list",
      "Active player's phone shows 'Your Turn' prominently",
      "Other players' phones show who is playing",
      "Host display shows active player's timeline large"
    ],
    "passes": true
  },
  {
    "category": "turns",
    "description": "Turn progresses to next player after completion",
    "steps": [
      "After steal phase ends",
      "Reveal results (correct/incorrect, any steals)",
      "Brief pause for results",
      "Advance to next player in order",
      "New song drawn and plays"
    ],
    "passes": true
  },
  {
    "category": "winning",
    "description": "Game ends when player reaches target songs",
    "steps": [
      "Check timeline count after each song added",
      "When player reaches configured target (default 10)",
      "Game immediately ends",
      "Winner announcement with celebration animation",
      "Transition to results screen"
    ],
    "passes": true
  },
  {
    "category": "winning",
    "description": "Results screen shows game leaderboard",
    "steps": [
      "Display all players ranked by timeline size",
      "Show winner prominently",
      "Display songs in each player's timeline",
      "Show token counts",
      "Show accuracy stats (correct placements vs total)"
    ],
    "passes": true
  },
  {
    "category": "winning",
    "description": "Results screen shows party stats",
    "steps": [
      "Display wins per player across party session",
      "Show games played count",
      "Show party MVP (most wins)"
    ],
    "passes": true
  },
  {
    "category": "winning",
    "description": "Host can start rematch",
    "steps": [
      "Rematch button visible only to host",
      "New players can join during results screen",
      "Click rematch to start new game",
      "Party stats preserved",
      "Game stats reset",
      "Return to lobby briefly then start"
    ],
    "passes": true
  },
  {
    "category": "playlist",
    "description": "Default playlist loaded if none specified",
    "steps": [
      "Default playlist: https://open.spotify.com/playlist/0Mpj1KwRmY2pHzmj7mfbdh",
      "Fetch tracks via Spotify API",
      "Store track pool for game session"
    ],
    "passes": true
  },
  {
    "category": "playlist",
    "description": "Host can specify custom playlist",
    "steps": [
      "Paste Spotify playlist URL in settings",
      "Validate playlist exists and is accessible",
      "Show warning if playlist has fewer than 100 tracks",
      "Load tracks from custom playlist"
    ],
    "passes": true
  },
  {
    "category": "playlist",
    "description": "Songs used only once per game",
    "steps": [
      "Track used songs in game state",
      "Never repeat a song in same game",
      "Remove used songs from pool"
    ],
    "passes": true
  },
  {
    "category": "playlist",
    "description": "Fallback to default if custom playlist exhausted",
    "steps": [
      "If custom playlist runs out of songs",
      "Switch to default playlist",
      "Notify players of fallback",
      "Continue game"
    ],
    "passes": true
  },
  {
    "category": "playlist",
    "description": "Handle total song exhaustion gracefully",
    "steps": [
      "If both playlists exhausted (edge case)",
      "End game early",
      "Declare winner based on current standings",
      "Show appropriate message"
    ],
    "passes": true
  },
  {
    "category": "reconnection",
    "description": "Disconnected players can rejoin",
    "steps": [
      "Player loses connection",
      "Disconnected player's avatar shows gray overlay or 'disconnected' badge within 5s of disconnect",
      "Player navigates back to join page",
      "Enter same PIN and name",
      "Player sees their timeline, token count, and current turn state exactly as before disconnect",
      "Resume participation"
    ],
    "passes": true
  },
  {
    "category": "reconnection",
    "description": "Host disconnection handled gracefully",
    "steps": [
      "If host disconnects during game",
      "Turn timer pauses, 'Waiting for host...' message shown to all players",
      "Show waiting indicator",
      "Host can rejoin and resume",
      "Song continues from where it paused, not from beginning"
    ],
    "passes": true
  },
  {
    "category": "display",
    "description": "Host main display shows current game state",
    "steps": [
      "Large view of active player's timeline",
      "Year text readable from 2m away on typical TV/monitor (min 24px at 1080p)",
      "Drag position highlighted during turn",
      "Timer visible in top corner, min 48px font",
      "Small progress indicators for all players (song counts)"
    ],
    "passes": true
  },
  {
    "category": "display",
    "description": "Player phone view optimized for mobile",
    "steps": [
      "Layout works on 320px-428px width without horizontal scroll",
      "Touch-friendly drag and drop",
      "Timeline scrollable horizontally",
      "All interactive elements min 44x44px touch target",
      "Clear token and timer display"
    ],
    "passes": true
  },
  {
    "category": "display",
    "description": "Theme toggle for light/dark mode",
    "steps": [
      "Toggle in settings/header",
      "Follow shadcn theming patterns",
      "Preference stored in localStorage, survives page refresh",
      "On first visit, follows prefers-color-scheme media query"
    ],
    "passes": true
  },
  {
    "category": "statistics",
    "description": "Full game data stored for host",
    "steps": [
      "Store complete game history in database",
      "Track each turn, placement, steal attempt",
      "Store all player data and results",
      "Link to host account"
    ],
    "passes": true
  },
  {
    "category": "statistics",
    "description": "Host dashboard shows game history",
    "steps": [
      "List of past games with dates",
      "Click to view detailed game stats",
      "Aggregate stats across all games",
      "Visual charts/graphs for stats (AccuracyChart area chart + GamesActivityChart bar chart using shadcn charts)"
    ],
    "passes": false
  },
  {
    "category": "statistics",
    "description": "Detailed stats per game",
    "steps": [
      "Winner and final standings",
      "Each player's accuracy percentage",
      "Tokens earned and spent per player (currently only shows remaining)",
      "Average seconds from song start to placement confirmation",
      "Songs guessed correctly (count and percentage)",
      "Show 'X/Y steals successful (Z%)'"
    ],
    "passes": false
  },
  {
    "category": "ui",
    "description": "Skeleton loaders for async content",
    "steps": [
      "During data fetch, gray animated placeholder matches layout of final content",
      "Use React Suspense boundaries",
      "Content fades in over 150-300ms, no layout shift"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Avatar selection with emoji presets",
    "steps": [
      "Grid of emoji avatar options",
      "Click to select",
      "Visual selection indicator",
      "Minimum 20 avatar options"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "QR code for easy game joining",
    "steps": [
      "Generate QR code with join URL + PIN",
      "Display alongside PIN in lobby",
      "Scannable on mobile devices"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Countdown timers with visual feedback",
    "steps": [
      "Circular or bar progress for timers",
      "Timer green >50%, yellow 25-50%, red <25%",
      "Last 5 seconds: timer pulses at 1Hz"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Drag and drop timeline interaction",
    "steps": [
      "Card follows touch/cursor at 60fps, no jank",
      "Clear drop zone indicators",
      "If device supports vibration API, short vibration on drop",
      "Snap-to-position behavior"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Turn shuffle animation",
    "steps": [
      "Visual player order cards",
      "Player cards animate to new positions over 500-800ms with easing",
      "Settle into new positions",
      "Highlight first player"
    ],
    "passes": true
  },
  {
    "category": "database",
    "description": "Database schema for game data",
    "steps": [
      "Users table (hosts with Spotify tokens)",
      "GameSessions table (PIN, settings, state)",
      "Players table (name, avatar, session link)",
      "GameHistory table (full game data JSON)",
      "Turns table (each turn details)",
      "All tables have proper foreign key constraints and indexes on frequently queried columns (PIN, session_id)"
    ],
    "passes": true
  },
  {
    "category": "api",
    "description": "tRPC subscriptions for real-time",
    "steps": [
      "Configure WebSocket or SSE transport",
      "Subscription for lobby updates",
      "Subscription for game state changes",
      "Subscription for turn/steal events",
      "If WebSocket connection fails, show connection error toast with retry button"
    ],
    "passes": true
  },
  {
    "category": "spotify",
    "description": "Spotify OAuth with required scopes",
    "steps": [
      "Configure Better Auth Spotify provider",
      "Request scopes: streaming, user-read-email, user-read-private, playlist-read-private",
      "Store and refresh access tokens",
      "When token expires, auto-refresh using refresh_token. If refresh fails, redirect to re-auth"
    ],
    "passes": true
  },
  {
    "category": "spotify",
    "description": "Spotify Web Playback SDK integration",
    "steps": [
      "Initialize SDK on host client",
      "Create player instance",
      "Transfer playback to web player",
      "Control play/pause/seek",
      "On playback error, show toast 'Playback failed - check Spotify Premium status', log error to console"
    ],
    "passes": true
  },
  {
    "category": "spotify",
    "description": "Fetch playlist tracks",
    "steps": [
      "Call Spotify API for playlist tracks",
      "Extract track ID, name, artist, release year",
      "For playlists >100 tracks, fetch all pages until complete",
      "Cache playlist data for session"
    ],
    "passes": true
  },
  {
    "category": "spotify",
    "description": "Hide song metadata during playback",
    "steps": [
      "Do not display track name or artist during turn",
      "Do not show album art",
      "Only reveal after placement confirmed",
      "Inspect DOM during playback, confirm no track name/artist in any element or data attribute"
    ],
    "passes": true
  },
  {
    "category": "deployment",
    "description": "Vercel-ready configuration",
    "steps": [
      "Environment variables configured",
      "Build outputs optimized",
      "Edge functions where appropriate"
    ],
    "passes": true
  },
  {
    "category": "deployment",
    "description": "Docker support for self-hosting",
    "steps": [
      "Dockerfile for production build",
      "Docker compose for full stack",
      "Environment variable documentation"
    ],
    "passes": true
  },
  {
    "category": "stealing",
    "description": "Two-phase steal: schema changes",
    "steps": [
      "Add stealPhase field to gameSessions: 'decide' | 'place' | null",
      "Add stealDecidePhaseEndAt timestamp field",
      "Add stealPlacePhaseEndAt timestamp field",
      "Add playerSkips array field to track who skipped",
      "Add decidedStealers array to track who clicked steal in decide phase",
      "Run db:push and verify schema updates",
      "DONE: npm run typecheck passes with new fields"
    ],
    "passes": true
  },
  {
    "category": "stealing",
    "description": "Two-phase steal: backend mutations",
    "steps": [
      "Modify confirmTurn to set stealPhase='decide' and stealDecidePhaseEndAt=now+10s",
      "Add decideToSteal mutation: deducts token, adds to decidedStealers array",
      "Add skipSteal mutation: adds player to playerSkips array",
      "Add transitionToPlacePhase: called when decide ends, sets stealPhase='place' and stealPlacePhaseEndAt=now+20s",
      "Modify submitSteal to only work in 'place' phase, allow late-joiners who pay token",
      "Modify resolveStealPhase to handle new two-phase data structure",
      "If all eligible players skip, immediately call resolveStealPhase and advance turn",
      "DONE: Can complete full steal flow via API calls"
    ],
    "passes": true
  },
  {
    "category": "stealing",
    "description": "Two-phase steal: decide phase UI",
    "steps": [
      "Show 'Steal (ðŸª™1)' and 'Skip' buttons to non-active players during decide phase",
      "Display 10s countdown timer for decide phase",
      "Clicking Steal calls decideToSteal mutation and disables button",
      "Clicking Skip calls skipSteal mutation and shows 'Skipped' state",
      "Show 'X/Y players decided' indicator",
      "Active player sees their timeline with placed song highlighted (glowing border)",
      "DONE: Non-active player can click Steal or Skip, see timer, see active player's timeline"
    ],
    "passes": true
  },
  {
    "category": "stealing",
    "description": "Two-phase steal: place phase UI",
    "steps": [
      "After decide phase, show 20s place phase timer for players who clicked Steal",
      "Stealers see active player's timeline (not their own) with drop zones",
      "Active player's placed song highlighted distinctly",
      "When stealer places, show their avatar/name on that position",
      "Block positions already taken by other stealers (show who claimed it)",
      "Late joiners can still click 'Steal' during place phase - immediately show timeline",
      "Auto-submit placement when timer expires",
      "DONE: Stealer can drag into active player's timeline, see other stealers' positions"
    ],
    "passes": true
  },
  {
    "category": "stealing",
    "description": "Steal phase skip functionality",
    "steps": [
      "Track eligible players count (all non-active players)",
      "Track skipped players count from playerSkips array",
      "When skipped count equals eligible count, immediately resolve steal phase",
      "Show visual indicator: 'Skipped: 2/3 players'",
      "Skip button disabled after clicking, shows checkmark",
      "DONE: If all 3 non-active players skip, steal phase ends within 1 second"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Spotify loading state and indicator",
    "steps": [
      "Add isLoading state to SpotifyPlayer, true when shouldPlay but not yet playing",
      "Host sees spinner and 'Loading song...' text while buffering",
      "Other players see 'Waiting for song...' message during load",
      "onPlaybackStarted sets isLoading=false",
      "DONE: Visible loading indicator appears before song plays, disappears when playing"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Turn timer synced to playback start",
    "steps": [
      "Add playbackStartedAt state to track when song actually started",
      "TurnTimer calculates remaining time from playbackStartedAt, not turnStartedAt",
      "Timer shows full duration until playback starts",
      "onPlaybackStarted callback sets playbackStartedAt=Date.now()",
      "DONE: With 5s Spotify delay, player still gets full 45s turn after song starts"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Prevent song restart on state changes",
    "steps": [
      "Add currentPlayingUri ref to track what's currently playing",
      "Skip playTrack call if URI matches currentPlayingUri",
      "Clear currentPlayingUri only when song should actually change (new turn)",
      "Add console.log for debugging: 'Skipping duplicate play call for {uri}'",
      "DONE: Song does not restart when game state updates during playback"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Result overlay 5 seconds with continued playback",
    "steps": [
      "Change TurnResultOverlay timeout from 4000 to 5000ms",
      "Verify song continues playing during result display (no pause call)",
      "All players see overlay via subscription update",
      "DONE: Result shows for 5 seconds, song audible throughout"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Guess feedback with color highlighting",
    "steps": [
      "In result overlay, show 'Your guess: {guessedName}' with green bg if correct, red if wrong",
      "Show 'Actual: {actualName}' below for comparison",
      "Same pattern for artist: green/red highlight based on correctness",
      "If guess bonus earned, show '+1 ðŸª™' with brief scale animation",
      "Text size min 16px for readability",
      "DONE: Can clearly see green highlight on correct guess, red on wrong"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Token display compact format",
    "steps": [
      "Replace repeated emoji with 'ðŸª™ x{count}' format",
      "On mobile (<640px), use even shorter 'ðŸª™{count}' format",
      "Max-width on token container prevents overflow",
      "DONE: Player with 10 tokens shows 'ðŸª™ x10', no horizontal scroll on 320px viewport"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Fix mobile horizontal scroll",
    "steps": [
      "Add overflow-x-hidden to main game container",
      "Constrain PlayerCard max-width to 100%",
      "Player name truncates with ellipsis if too long",
      "Badges wrap to new line on very small screens",
      "Remove -mx-2 negative margins or contain them properly",
      "DONE: No horizontal scrollbar on 320px iPhone SE viewport in DevTools"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Mobile timeline polish",
    "steps": [
      "Keep horizontal scroll on mobile (user can rotate phone)",
      "Increase card min-width so song name/artist don't truncate aggressively",
      "Year prominent (bold, large font), song name and artist readable",
      "Smooth horizontal scroll with snap points",
      "Touch-friendly drag-and-drop with clear drop zone indicators",
      "Timeline scrolls to show new card when placed",
      "DONE: Timeline readable on 375px, no truncation, smooth scroll and drag"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Mobile turn indicator clarity",
    "steps": [
      "Add prominent banner at top: '{PlayerName}'s Turn' or 'Your Turn!' in contrasting color",
      "Show current phase below: 'Placing song' / 'Steal Phase' / 'Results'",
      "Your Turn banner uses primary color background, pulsing border",
      "Other player's turn uses muted background",
      "DONE: Immediately obvious whose turn it is and what phase on mobile"
    ],
    "passes": true
  },
  {
    "category": "api",
    "description": "Document subscription limitations",
    "steps": [
      "Test SSE on Vercel deployment with 2+ players",
      "Measure average latency from mutation to UI update",
      "Test background tab behavior on mobile Safari/Chrome",
      "Document findings in README or CLAUDE.md",
      "If latency >3s consistently, note that VPS deployment recommended",
      "DONE: README has 'Real-time Performance' section with findings"
    ],
    "passes": false
  },
  {
    "category": "api",
    "description": "Player reconnection after refresh",
    "steps": [
      "Player refreshes page mid-game",
      "Session cookie preserved, player auto-rejoins same game",
      "Game state restored: timeline, tokens, current phase",
      "If was active player, turn timer resumes (not reset)",
      "Test: refresh during turn, during steal, during results",
      "DONE: Can refresh browser and continue playing without data loss"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Game over back to home button",
    "steps": [
      "Add 'Back to Home' button on game over screen",
      "Button uses Link component to '/' route",
      "Visible to all players (host and non-host)",
      "Positioned in button row with Rematch button",
      "DONE: Clicking 'Back to Home' navigates to home page"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Winner confetti animation",
    "steps": [
      "Install: npm install @neoconfetti/react",
      "Import Confetti component in game over screen",
      "Trigger confetti when winner declared (gameEnded && winner)",
      "Confetti renders for 4 seconds then stops",
      "Use app theme colors for confetti pieces",
      "DONE: Confetti explodes on screen when game ends"
    ],
    "passes": true
  },
  {
    "category": "ui-polish",
    "description": "Home page visual polish",
    "steps": [
      "Replace generic 'Welcome' with personality: 'Ready to test your music knowledge?'",
      "Login button: larger, primary color, centered",
      "Add subtle background gradient or pattern",
      "Spacing: min 24px between sections",
      "DONE: Home page feels polished, not like default template"
    ],
    "passes": true
  },
  {
    "category": "ui-polish",
    "description": "Lobby waiting state polish",
    "steps": [
      "PIN display: large monospace font, letter-spacing for readability",
      "QR code: white background padding, subtle shadow",
      "Waiting message with personality: 'Waiting for friends to join...' with animated dots",
      "Player list: cards with subtle hover state, smooth enter animation",
      "DONE: Lobby feels alive and polished while waiting"
    ],
    "passes": true
  },
  {
    "category": "ui-polish",
    "description": "Player card visual hierarchy",
    "steps": [
      "Active player card: colored left border (4px primary), subtle glow",
      "Avatar: 48px on mobile, 56px on desktop",
      "Name: font-semibold, truncate with ellipsis",
      "Token count: right-aligned, muted color until low (<2 = warning color)",
      "Disconnected state: grayscale filter, 'Reconnecting...' badge",
      "DONE: Can instantly identify active player and player status at a glance"
    ],
    "passes": true
  },
  {
    "category": "ui-polish",
    "description": "Song card design polish",
    "steps": [
      "Year: bold, 24px minimum, high contrast",
      "Song name: 14px, truncate at 2 lines with ellipsis",
      "Artist: 12px, muted color, single line truncate",
      "Card: subtle gradient background, 8px border-radius",
      "Placed card: success green border when correct, red when wrong",
      "DONE: Song cards readable, year prominent, correct/incorrect obvious"
    ],
    "passes": true
  },
  {
    "category": "ui-polish",
    "description": "Timer urgency states",
    "steps": [
      "Timer >50%: default text color",
      "Timer 25-50%: amber/warning color",
      "Timer <25%: red color, pulse animation",
      "Timer <10s: add subtle screen edge glow/vignette",
      "Font: tabular-nums for stable width during countdown",
      "DONE: Timer creates urgency through color progression"
    ],
    "passes": true
  },
  {
    "category": "ui-polish",
    "description": "Button hierarchy and states",
    "steps": [
      "Primary action (Confirm, Start): filled primary color, hover darken",
      "Secondary action (Skip, Settings): outline style, hover fill",
      "Destructive action (Leave): red outline, hover red fill",
      "Disabled state: 50% opacity, cursor-not-allowed",
      "Loading state: spinner replaces text, maintains button width",
      "All buttons: min 44px height for touch",
      "DONE: Button importance clear from visual weight"
    ],
    "passes": true
  },
  {
    "category": "ui-polish",
    "description": "Toast and feedback styling",
    "steps": [
      "Success toast: green left border, checkmark icon",
      "Error toast: red left border, X icon",
      "Info toast: blue left border, info icon",
      "Toast position: top-center on mobile, top-right on desktop",
      "Animation: slide down + fade in, 300ms ease-out",
      "DONE: Toasts feel polished and match app style"
    ],
    "passes": true
  },
  {
    "category": "ui-polish",
    "description": "Empty states with personality",
    "steps": [
      "Empty timeline: 'No songs yet - your musical journey starts here!'",
      "No games played: 'Your game history is empty. Time to play!'",
      "No players joined: 'Share the PIN and wait for friends to join'",
      "Use appropriate emoji or illustration",
      "Muted text color, centered",
      "DONE: Empty states helpful and have character"
    ],
    "passes": true
  },
  {
    "category": "ui-polish",
    "description": "Loading skeleton polish",
    "steps": [
      "Skeleton matches layout of loaded content (same heights/widths)",
      "Subtle shimmer animation left-to-right",
      "Use for: player list, timeline cards, game history",
      "Skeleton to content: crossfade transition 200ms",
      "DONE: Loading states feel smooth, no layout shift on load"
    ],
    "passes": true
  },
  {
    "category": "ui-polish",
    "description": "Dark mode polish pass",
    "steps": [
      "Verify all text meets 4.5:1 contrast ratio in dark mode",
      "Cards use dark surface color, not pure black",
      "Borders visible but subtle in dark mode",
      "No pure white text (use gray-100 instead)",
      "Test all screens in dark mode",
      "DONE: Dark mode polished and accessible"
    ],
    "passes": false
  },
  {
    "category": "ui-polish",
    "description": "Microinteractions pass",
    "steps": [
      "Buttons: scale(0.98) on active",
      "Cards: subtle lift (translateY -2px, shadow increase) on hover",
      "Page transitions: fade 150ms",
      "Drag start: slight scale up (1.05), shadow increase",
      "Drop: brief scale pulse animation",
      "DONE: UI feels responsive and alive"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Fix settings number inputs to allow clearing before typing",
    "steps": [
      "Number inputs block backspace when value at min (e.g., can't clear '1' to type '2')",
      "Allow empty/intermediate states during editing",
      "Only clamp to min/max on blur or form submit",
      "DONE: Can backspace to clear input, type new value, min enforced on blur"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Improve settings save UX with feedback",
    "steps": [
      "Show success toast when settings saved",
      "Auto-close settings panel after successful save",
      "DONE: Save shows toast confirmation and closes panel"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Simplify timer UI - remove song progress bar",
    "steps": [
      "Remove song progress bar (confusing with two countdowns)",
      "Keep only the round/turn timer",
      "On refresh, sync turn timer to correct remaining time from server",
      "DONE: Single timer, syncs correctly after page refresh"
    ],
    "passes": true
  },
  {
    "category": "lobby",
    "description": "QR code uses local network IP in dev mode",
    "steps": [
      "Detect local network IP (192.168.x.x) on server",
      "In dev mode, generate QR with local IP instead of localhost",
      "Other devices on same network can scan and join",
      "DONE: Phone on same WiFi can scan QR and reach game"
    ],
    "passes": false
  },
  {
    "category": "ui",
    "description": "Remove duplicate 'Your Timeline' on other player's turn",
    "steps": [
      "When watching (not your turn), remove standalone 'Your Timeline' section",
      "Player list shows all timelines - ensure current user is always first",
      "Reduces redundancy and clutter",
      "Your turn: still shows prominent timeline for placing songs",
      "DONE: No duplicate timeline when watching, you're always top of player list"
    ],
    "passes": true
  },
  {
    "category": "lobby",
    "description": "Shuffle turns as optional setting",
    "steps": [
      "Add 'Shuffle turn order each round' toggle to game settings",
      "Default to off (fixed turn order)",
      "When on, shuffles player order at start of each round",
      "DONE: Setting visible in lobby, respects toggle during gameplay"
    ],
    "passes": true
  },
  {
    "category": "gameplay",
    "description": "Continuous song playback across phases",
    "steps": [
      "Remove separate 'song play duration' setting",
      "Song plays continuously through turn phase AND steal phase",
      "Turn timer (45s) and steal timer (10s+20s) remain separate",
      "Song only stops when next turn starts",
      "Simplifies settings UI and playback logic",
      "DONE: Song plays throughout all phases, no restart between phases"
    ],
    "passes": true
  },
  {
    "category": "playlist",
    "description": "Add ISRC field and year lookup schema changes",
    "steps": [
      "Add isrc?: string to PlaylistSong type in schema.ts",
      "Add spotifyYear?: number to PlaylistSong (to preserve original Spotify date)",
      "Add isrc?: string to CurrentTurnSong and TimelineSong types",
      "Create yearLookupStatusEnum with values: pending, in_progress, complete",
      "Add yearLookupStatus, yearLookupProgress, yearLookupTotal fields to gameSessions",
      "Create isrcYearCache table with: isrc (PK), originalYear, spotifyYear, createdAt",
      "Run db:push to apply schema changes",
      "DONE: npm run typecheck passes, db:push succeeds"
    ],
    "passes": false
  },
  {
    "category": "playlist",
    "description": "Extract ISRC from Spotify playlist tracks API",
    "steps": [
      "In spotify.ts getPlaylistTracks, update TS type to include external_ids: { isrc?: string }",
      "Extract isrc from track.external_ids?.isrc when mapping tracks",
      "Store both isrc and spotifyYear (album.release_date) in PlaylistSong",
      "In game.ts fetchPlaylistTracks helper, apply same changes",
      "Update PLACEHOLDER_SONGS to include dummy ISRC values for testing",
      "DONE: Console.log shows ISRC values when fetching real Spotify playlist"
    ],
    "passes": false
  },
  {
    "category": "playlist",
    "description": "Create MusicBrainz service with rate limiting",
    "steps": [
      "Create src/lib/musicbrainz.ts",
      "Add rate limiter that enforces 1 request per second (MusicBrainz strict limit)",
      "Implement getOriginalYear(isrc: string): Promise<number | null>",
      "Call GET https://musicbrainz.org/ws/2/isrc/{ISRC}?fmt=json",
      "Set User-Agent header: 'Hitster/1.0 (contact@example.com)' (required by MusicBrainz)",
      "Parse response.recordings[].first-release-date, return earliest year found",
      "Return null if no recordings found or API error",
      "DONE: Manual test with known ISRC (e.g., GBUM71029604 for Bohemian Rhapsody) returns 1975"
    ],
    "passes": false
  },
  {
    "category": "playlist",
    "description": "Add ISRC year cache lookup and storage",
    "steps": [
      "In musicbrainz.ts, add getCachedYear(isrc: string): Promise<number | null>",
      "Query isrcYearCache table for existing entry",
      "Add cacheYear(isrc: string, originalYear: number, spotifyYear?: number)",
      "Insert into isrcYearCache table on successful MusicBrainz lookup",
      "Modify getOriginalYear to check cache first, only call API if not cached",
      "DONE: Second lookup for same ISRC returns cached value (no API call in logs)"
    ],
    "passes": false
  },
  {
    "category": "playlist",
    "description": "Background year lookup on game creation",
    "steps": [
      "In game.ts createGame mutation, after fetching playlist songs:",
      "Set yearLookupStatus='in_progress', yearLookupTotal=songs.length, yearLookupProgress=0",
      "Create async function processYearLookups(sessionId, songs) - do NOT await it",
      "Loop through songs with ISRCs, call getOriginalYear for each",
      "Update song.year with MusicBrainz result if found, keep Spotify year as fallback",
      "Increment yearLookupProgress after each song, emit session update",
      "Set yearLookupStatus='complete' when done",
      "DONE: Creating game shows yearLookupProgress incrementing in DB"
    ],
    "passes": false
  },
  {
    "category": "playlist",
    "description": "Show year lookup progress in lobby UI",
    "steps": [
      "Add yearLookupStatus, yearLookupProgress, yearLookupTotal to session query response",
      "In LobbyView, show progress indicator when yearLookupStatus is 'in_progress'",
      "Display 'Fetching song data... X/Y' with progress bar",
      "Show checkmark and 'Song data ready' when status is 'complete'",
      "Show '(Using approximate dates)' if status still 'in_progress' when starting",
      "Start button always enabled - game can start with Spotify years as fallback",
      "DONE: Creating game shows progress bar, completes after ~100 seconds for 100 songs"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Add Zustand with persist middleware for player state",
    "steps": [
      "Install zustand: bun add zustand",
      "Create src/stores/player-store.ts with PlayerStore interface",
      "Store shape: playerId, sessionId, gamePin, setPlayer(), clearPlayer()",
      "Use persist middleware with storage key 'hitster-player'",
      "Set skipHydration: true for SSR safety",
      "Export usePlayerStore hook and usePlayerStoreHydration hook for manual hydration",
      "DONE: bun run typecheck passes, store exports work"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Migrate localStorage writes to Zustand player store",
    "steps": [
      "Update src/components/create-game-button.tsx: replace 3 localStorage.setItem calls with usePlayerStore().setPlayer()",
      "Update src/app/join/page.tsx: replace 3 localStorage.setItem calls with usePlayerStore().setPlayer()",
      "Add hydration useEffect to app layout or provider",
      "Remove hitster_player_id, hitster_session_id, hitster_game_pin keys (now single hitster-player key)",
      "DONE: Creating/joining game persists player to single localStorage key"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Extract player heartbeat logic to custom hook",
    "steps": [
      "Create src/hooks/use-player-heartbeat.ts",
      "Accept playerId param, send heartbeat mutation every 3s when playerId exists",
      "Handle cleanup on unmount (clearInterval)",
      "Update src/app/lobby/[pin]/page.tsx: replace heartbeat useEffect with usePlayerHeartbeat(currentPlayerId)",
      "Update src/app/game/[pin]/page.tsx: replace heartbeat useEffect with usePlayerHeartbeat(currentPlayerId)",
      "Remove biome-ignore comments from both pages",
      "DONE: Heartbeat works, zero duplicated interval logic between pages"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Extract player validation logic to custom hook",
    "steps": [
      "Create src/hooks/use-player-validation.ts",
      "Read playerId and gamePin from Zustand store (with hydration check)",
      "Accept sessionData and currentPin params",
      "Return { playerId, isValidated, isLoading }",
      "Handle redirect to /join when player not found in session",
      "Update lobby page: replace 2 validation useEffects with usePlayerValidation()",
      "Update game page: replace 2 validation useEffects with usePlayerValidation()",
      "DONE: Both pages use shared hook, ~50 lines of duplicated logic removed"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Extract GameSkeleton to separate component file",
    "steps": [
      "Create src/components/game/game-skeleton.tsx",
      "Move GameSkeleton component from game page (lines 27-97)",
      "Export as named export",
      "Update game page import",
      "DONE: GameSkeleton in separate file, game page imports it"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Extract TurnResultOverlay to separate component file",
    "steps": [
      "Create src/components/game/turn-result-overlay.tsx",
      "Move TurnResultOverlay component and its types from game page (lines 423-571)",
      "Keep TurnResult interface in same file or create types file",
      "Export component and types",
      "Update game page to import TurnResultOverlay",
      "DONE: TurnResultOverlay in separate file (~150 lines extracted)"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Extract PlayerProgressBar to separate component file",
    "steps": [
      "Create src/components/game/player-progress-bar.tsx",
      "Move PlayerProgressBar component from game page (lines 216-271)",
      "Define props interface explicitly",
      "Update game page to import PlayerProgressBar",
      "DONE: PlayerProgressBar in separate file (~55 lines extracted)"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Extract ActivePlayerTimeline to separate component file",
    "steps": [
      "Create src/components/game/active-player-timeline.tsx",
      "Move ActivePlayerTimeline component from game page (lines 273-421)",
      "Include TimelineDisplay helper component it uses",
      "Define props interface explicitly",
      "Update game page to import ActivePlayerTimeline",
      "DONE: ActivePlayerTimeline in separate file (~150 lines extracted)"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Extract game finished screen to separate component",
    "steps": [
      "Create src/components/game/game-finished-screen.tsx",
      "Move finished game rendering from game page (lines 831-1052)",
      "Include leaderboard, party stats, rematch button logic",
      "Props: session data, handlers for rematch/home navigation",
      "Update game page to conditionally render GameFinishedScreen",
      "DONE: GameFinishedScreen in separate file (~220 lines extracted)"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Create pure selector functions for game data",
    "steps": [
      "Create src/lib/game-selectors.ts",
      "Add getPlayersSortedByTimeline(players) - sort by timeline.length desc",
      "Add getPlayersSortedByWins(players) - sort by wins desc",
      "Add getTimelineSortedByYear(timeline) - sort by year asc",
      "Add getCurrentPlayer(session) - find player matching currentPlayerId",
      "Update game page: replace inline sort/find calls with selectors",
      "Update GameFinishedScreen: use selectors",
      "DONE: Zero inline .sort() calls in render, all use selectors"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Create useGameState hook for computed game values",
    "steps": [
      "Create src/hooks/use-game-state.ts",
      "Accept session data and currentPlayerId",
      "Return computed values: currentPlayer, myPlayer, isMyTurn, isStealPhase, isHost",
      "Use selectors from game-selectors.ts",
      "Update game page: replace inline derivations with useGameState()",
      "Remove lines 1055-1063 inline data derivation",
      "DONE: Game page uses hook for all computed state, cleaner render logic"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Consolidate game mutation handlers into hook",
    "steps": [
      "Create src/hooks/use-game-mutations.ts",
      "Accept pin param",
      "Return mutations: confirmTurn, submitSteal, resolveStealPhase, skipSong, freeSong, startRematch",
      "Each mutation includes query invalidation (shared pattern)",
      "Update game page: replace 6 individual useMutation calls with useGameMutations(pin)",
      "Remove duplicated queryClient.invalidateQueries patterns",
      "DONE: Single hook for all game mutations, consistent invalidation"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Simplify game page conditional rendering",
    "steps": [
      "Review remaining game page code after extractions",
      "Group related conditional blocks into clearly named sections",
      "Consider extracting WaitingForTurn and MyTurnView if still complex",
      "Ensure game page is under 400 lines total",
      "Remove any dead code or unused imports",
      "Run bun run typecheck and bun run test",
      "DONE: Game page under 400 lines, readable conditional flow"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Remove unused hitster_session_id localStorage key",
    "steps": [
      "hitster_session_id is written but never read (dead code)",
      "Remove from create-game-button.tsx if still present after Zustand migration",
      "Remove from join/page.tsx if still present",
      "Verify Zustand store only persists needed fields",
      "DONE: No writes to hitster_session_id, grep returns zero results"
    ],
    "passes": false
  },
  {
    "category": "playlist",
    "description": "Fix duplicate songs appearing in same game",
    "steps": [
      "Investigate how songs are selected - check game.ts drawNextSong or similar",
      "Track ALL used song IDs across entire game session (not just current playlist)",
      "When falling back from custom playlist to default, exclude already-used songs",
      "Ensure usedSongIds persists in game session state",
      "Add unit test: draw 50 songs, verify no duplicates in IDs",
      "DONE: Play full game with playlist fallback, no song appears twice"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Extract Spotify SDK initialization to useSpotifySDK hook",
    "steps": [
      "Create src/hooks/use-spotify-sdk.ts",
      "Move SDK script loading, player creation, event listeners from SpotifyPlayer",
      "Use refs for callbacks to prevent re-initialization on prop changes",
      "Only re-init when isHost changes or initial token arrives (boolean dep)",
      "Return { player, deviceId, isReady, error }",
      "Hook handles connect/disconnect lifecycle",
      "DONE: SDK initializes once per session, device ID stable across re-renders"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Extract playback mutations to useSpotifyPlayback hook",
    "steps": [
      "Create src/hooks/use-spotify-playback.ts",
      "Move playTrack, pausePlayback, transferPlayback mutations",
      "Accept deviceId from useSpotifySDK",
      "Track currentPlayingUri to prevent duplicate play calls",
      "Handle reauth redirect on token errors",
      "Return { play, pause, transfer, isLoading, error }",
      "DONE: Playback control decoupled from SDK lifecycle"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Refactor SpotifyPlayer to compose extracted hooks",
    "steps": [
      "Replace 200+ lines of effects with useSpotifySDK + useSpotifyPlayback",
      "Remove callback refs workaround (handled in hooks)",
      "Keep only orchestration logic and UI rendering",
      "Target: under 100 lines for SpotifyPlayer component",
      "All lint errors resolved (no eslint-disable comments needed)",
      "DONE: SpotifyPlayer under 100 lines, composes hooks cleanly"
    ],
    "passes": false
  },
  {
    "category": "refactor",
    "description": "Add SDK initialization guard to prevent duplicate instances",
    "steps": [
      "Track SDK initialization state in module-level variable",
      "Prevent second initialization if already connected",
      "Handle page visibility changes (pause/resume when tab hidden)",
      "Clean up properly on component unmount",
      "DONE: Only one Spotify player in device list regardless of re-renders"
    ],
    "passes": false
  },
  {
    "category": "standards",
    "description": "Audit components for shadcn migration opportunities",
    "steps": [
      "Review src/components/ for custom implementations of common UI patterns",
      "Check for: toast/notification, dialog/modal, popover, tooltip, alert, dropdown",
      "Document findings: which components exist, what shadcn equivalents are available",
      "Check if sonner is already installed (package.json) or if custom toast exists",
      "List in this task's notes: components to migrate and shadcn components to add",
      "DONE: Audit complete, migration list documented"
    ],
    "passes": false
  },
  {
    "category": "standards",
    "description": "Migrate to shadcn components (based on audit)",
    "steps": [
      "Add shadcn sonner for toasts: bunx --bun shadcn@latest add sonner",
      "Add <Toaster /> to app/layout.tsx from @/components/ui/sonner",
      "Replace custom toast implementations with sonner's toast() API",
      "Add other shadcn components identified in audit: bunx --bun shadcn@latest add <component>",
      "Remove deprecated custom component files after migration",
      "DONE: All identified components migrated to shadcn equivalents"
    ],
    "passes": false
  },
  {
    "category": "standards",
    "description": "Document shadcn-first component policy",
    "steps": [
      "Add to CLAUDE.md: '## Component Standards' section",
      "Document: always check https://ui.shadcn.com/docs/components before building custom",
      "List commonly used shadcn components: Button, Card, Dialog, Input, Form, Toast (sonner), etc.",
      "Note: run 'bunx --bun shadcn@latest add <component>' to add new components",
      "DONE: CLAUDE.md has component standards section, devs know to check shadcn first"
    ],
    "passes": false
  }
]
